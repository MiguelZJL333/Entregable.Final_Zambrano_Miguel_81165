<div class="container mt-5">
    <h1>Mi Carrito</h1>

    {{#if products}}
        {{#if (gt products.length 0)}}
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Producto</th>
                        <th>Precio Unitario</th>
                        <th>Cantidad</th>
                        <th>Subtotal</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {{#each products}}
                    <tr>
                        <td>{{this.product.title}}</td>
                        <td>${{this.product.price}}</td>
                        <td>
                            <input type="number" class="quantity-input" data-product-id="{{this.product._id}}" value="{{this.quantity}}" min="1">
                        </td>
                        <td>${{multiply this.product.price this.quantity}}</td>
                        <td>
                            <button class="btn btn-sm btn-danger remove-product" data-product-id="{{this.product._id}}">Eliminar</button>
                        </td>
                    </tr>
                    {{/each}}
                </tbody>
            </table>

            <div class="row mt-4">
                <div class="col-md-12 text-right">
                    <h3>Total del Carrito: $<span id="totalPrice">0</span></h3>
                </div>
            </div>

            <div class="row mt-4">
                <div class="col-md-12">
                    <button class="btn btn-danger btn-lg" id="emptyCartBtn">Vaciar Carrito</button>
                    <a href="/" class="btn btn-primary btn-lg">Seguir Comprando</a>
                    <button class="btn btn-success btn-lg" id="checkoutBtn">Proceder al Pago</button>
                </div>
            </div>
        {{else}}
            <div class="alert alert-info">
                Tu carrito está vacío
            </div>
            <a href="/" class="btn btn-primary">Volver a Productos</a>
        {{/if}}
    {{else}}
        <div class="alert alert-warning">
            Carrito no encontrado
        </div>
        <a href="/" class="btn btn-primary">Volver a Productos</a>
    {{/if}}
</div>

<script>
const cartId = '{{cart._id}}';

function calculateTotal() {
    let total = 0;
    document.querySelectorAll('tbody tr').forEach(row => {
        const price = parseFloat(row.querySelector('td:nth-child(2)').textContent.replace('$', ''));
        const quantity = parseInt(row.querySelector('.quantity-input').value);
        total += price * quantity;
    });
    document.getElementById('totalPrice').textContent = total.toFixed(2);
}

document.querySelectorAll('.quantity-input').forEach(input => {
    input.addEventListener('change', async function() {
        const productId = this.getAttribute('data-product-id');
        const quantity = this.value;
        
        if (quantity < 1) {
            alert('La cantidad debe ser mayor a 0');
            this.value = 1;
            return;
        }
        
        try {
            const response = await fetch(`/api/carts/${cartId}/products/${productId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ quantity: parseInt(quantity) })
            });
            
            if (response.ok) {
                console.log('Cantidad actualizada');
                calculateTotal();
            } else {
                alert('Error al actualizar la cantidad');
                location.reload();
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error al actualizar la cantidad');
        }
    });
});

document.querySelectorAll('.remove-product').forEach(button => {
    button.addEventListener('click', async function() {
        const productId = this.getAttribute('data-product-id');
        if (confirm('¿Eliminar este producto del carrito?')) {
            try {
                const response = await fetch(`/api/carts/${cartId}/products/${productId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    console.log('Producto eliminado');
                    this.closest('tr').remove();
                    
                    // Si no hay más productos, mostrar mensaje
                    if (document.querySelectorAll('tbody tr').length === 0) {
                        location.reload();
                    }
                    
                    calculateTotal();
                } else {
                    alert('Error al eliminar el producto');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al eliminar el producto');
            }
        }
    });
});

document.getElementById('emptyCartBtn').addEventListener('click', async function() {
    if (confirm('¿Vaciar todo el carrito?')) {
        try {
            const response = await fetch(`/api/carts/${cartId}`, {
                method: 'DELETE'
            });
            
            if (response.ok) {
                console.log('Carrito vaciado');
                location.reload();
            } else {
                alert('Error al vaciar el carrito');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error al vaciar el carrito');
        }
    }
});

document.getElementById('checkoutBtn').addEventListener('click', function() {
    alert('Funcionalidad de pago no implementada aún');
});

// Calcular total inicial
calculateTotal();
</script>

<style>
    .quantity-input {
        width: 80px;
    }
    
    .text-right {
        text-align: right;
    }
</style>
